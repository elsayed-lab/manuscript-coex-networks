---
author: V. Keith Hughitt
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  settings: ""
  title: "Consensus Co-expression Network Construction"
  version: ""
  analysis_dirname: "03-consensus-network-construction"
title: "`r params$title` (`r params$version`)"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
  pdf_document:
    toc: true
    latex_engine: xelatex
---

Introduction
============

The goal of this analysis is to construct a consensus co-expression network by
summing the adjacency matrices for multiple network parameterizations, and then
compare the effect of pruning low-confidence network edges and genes at various
thresholds.

See the "Consensus co-expression network" analysis for a more thorough
explanation of the basic approach, and some alternative methods for
constructing the consensus network.

Methods
=======

```{r load_libraries, message=FALSE, results='hide'}
library('biomaRt')
library('clusteval')
library('doParallel')
library('plyr')
library('dplyr')
library('dynamicTreeCut')
library('DT')
library('flashClust')
library('foreach')
library('ggplot2')
library('goseq')
library('gplots')
library('hpgltools')
library('knitr')
library('knitcitations')
library('reshape2')
library('tools')

source('../../2015/00-shared/R/annotations.R')
source('../../2015/00-shared/R/enrichment_analysis.R')
source('../../2015/00-shared/R/filtering.R')
source('../../2015/00-shared/R/util.R')
source('../../2015/00-shared/R/wgcna.R')
```

```{r child='child/00-shared-setup.Rmd'}
```

```{r child='../../2015/00-shared/Rmd/init/load_counts.Rmd'}
```

```{r child='../../2015/00-shared/Rmd/init/load_host_annotations.Rmd', eval=CONFIG$target == 'host'}
```

```{r child='../../2015/00-shared/Rmd/init/load_pathogen_annotations.Rmd', eval=CONFIG$target == 'pathogen'}
```

```{r child='child/03-build-consensus-net.Rmd'}
```

```{r child='child/03-consensus-net-functional-enrichment.Rmd'}
```

Results
=======

```{r child='child/03-consensus-net-vs-indiv-nets.Rmd'}
```

```{r save_rdata}
# save RData files to output dir
save(adjmat, file=file.path(output_datadir, paste0('adjmat_', output_suffix, '.rda')))

#save(dat, dat_num_unique,  dat_ratio_enrichment,
#     file=file.path(output_datadir, paste0('results_', output_suffix, '.rda')))
```

```{r save_tables}
# save tables to output dir
write.csv(table_1, file=file.path(output_tabledir, paste0('table_01_', output_suffix, '.csv')),
          quote=FALSE, row.names=FALSE)
```

```{r save_output, include=FALSE}
# Give rmarkdown some time to finish convern and then copy original rmarkdown
# along with output images and HTML to archive location
html_filepath <- file.path(output_prefix, paste0('network_construction_', MANUSCRIPT_CONFIG$output_prefix, '.html'))
pdf_filepath <- sub('html', 'pdf', html_filepath)

if (opts_knit$get("rmarkdown.pandoc.to") == 'latex') {
    system(sprintf('(sleep 30 && mv 03-consensus-network-construction.pdf %s) &', pdf_filepath))
} else {
    system(sprintf('(sleep 30 && mv 03-consensus-network-construction.html %s) &', html_filepath))
}
```

