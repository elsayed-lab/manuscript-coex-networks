---
author: V. Keith Hughitt
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  settings: ""
  title: "Consensus Co-expression Network Construction"
  version: "1.0"
  analysis_dirname: "02-network-construction"
title: "`r params$title` (`r params$version`)"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
  pdf_document:
    toc: true
    latex_engine: xelatex
---

Introduction
============

**Overview**

This goal of this analysis is to combine information from multiple alternative
network parameterizations for the same dataset into a single consensus network.
While it's not possible to know which, if any, single network parameterization
is optimal, by aggregating across a large number of networks, we may be able to
arrive at a single more robust network topology or cluster partitioning.

**Consensus co-expression network construction**

To construct a consensus co-expression network, we will load the stored
adjacency matrices for each alternative network constructed, and stack them to
create a single combined adjacency matrix. Edges with support from a large
number of networks will thus have larger edge weights while those with less
support will have lower combined edge weights. Hierarchical clustering and
tree-cutting can then be used to derrive the usual network partitioning from
this combined data.

One approach to generating a robust filtered network is to prune edges from the
network that fall below a certain limit. By applying a sufficiently stringent
cutoff, many of the non-robust edges can be removed. Afterwards, genes which
become completely disconnected can also be removed to reduce the size of the
dataset.


Methods
=======

## Setup

```{r load_libraries, message=FALSE, results='hide'}
library('biomaRt')
library('clusteval')
library('doParallel')
library('dplyr')
library('DT')
library('dynamicTreeCut')
library('flashClust')
library('foreach')
library('goseq')
library('gplots')
library('ggplot2')
library('gridExtra')
library('hpgltools')
library('infotheo')
library('igraph')
library('knitr')
library('knitcitations')
library('matrixStats')
library('readr')
library('RColorBrewer')
library('reshape2')
library('tibble')
library('tools')
library('venneuler')
library('viridis')
library('WGCNA')
library('xlsx')

source('../../2015/00-shared/R/annotations.R')
source('../../2015/00-shared/R/count_tables.R')
source('../../2015/00-shared/R/enrichment_analysis.R')
source('../../2015/00-shared/R/filtering.R')
source('../../2015/00-shared/R/plots.R')
source('../../2015/00-shared/R/util.R')
source('../../2015/00-shared/R/wgcna.R')

options(stringsAsFactors=FALSE)
```

```{r child='child/00-shared-setup.Rmd'}
```

```{r include=FALSE}
opts_chunk$set(fig.width=1080/192, fig.height=1080/192)
```

```{r child='../../2015/00-shared/Rmd/init/load_counts.Rmd'}
```

```{r library_sizes, message=FALSE, dpi=192}
# color scheme for plots
num_conditions <- length(unique(condition))
pal <- colorRampPalette(brewer.pal(8, 'Dark2'))(num_conditions)
colors <- pal[as.numeric(condition)]

plot_libsize(count_table, condition, colors=colors, scale=FALSE)
```

```{r child='../../2015/00-shared/Rmd/init/load_pathogen_annotations.Rmd', eval=CONFIG$target == 'pathogen'}
```

```{r child='../../2015/00-shared/Rmd/init/load_host_annotations.Rmd', eval=CONFIG$target == 'host'}
```

```{r child='child/00-shared-build-consensus-net.Rmd'}
```

## Filtered consensus co-expression network

```{r child='child/02-create-filtered-consensus-net.Rmd'}
```

```{r child='child/02-detect-consensus-net-modules.Rmd'}
```

```{r child='child/02-module-expression-plots.Rmd'}
```

```{r create_net_annotation_df}
# create dataframe to use for network node annotations
result <- cbind(gene_info, color=module_colors)
annot <- cbind(gene_info, color=module_colors, cluster=module_labels)
```

## Functional enrichment

```{r child='../../2015/00-shared/Rmd/results/go_enrichment_network.Rmd'}
```

```{r child='../../2015/00-shared/Rmd/results/kegg_enrichment_network.Rmd'}
```

```{r child='child/02-kegg-enrichment-results.Rmd'}
```

```{r child='../../2015/00-shared/Rmd/results/hsapiens_marbach2016_tf_enrichment.Rmd', eval=CONFIG$target == 'host' && CONFIG$host == 'H. sapiens'}
```

```{r child='child/02-tf-regulon-enrichment-results.Rmd', eval=CONFIG$target == 'host' && CONFIG$host == 'H. sapiens'}
```

```{r child='../../2015/00-shared/Rmd/results/cpdb_enrichment_network.Rmd', eval=CONFIG$target == 'host'}
```

```{r child='../../2015/00-shared/Rmd/results/secreted_proteins.Rmd', eval=CONFIG$target == 'pathogen'}
```

```{r child='child/00-shared-summary-of-enrichment-results.Rmd'}
```

```{r child='child/02-top-enriched-modules.Rmd'}
```

```{r child='child/02-hslm-inf.Rmd', eval=MANUSCRIPT_CONFIG$output_dirname == 'hslm-inf'}
```

```{r child='child/02-hstc-inf.Rmd', eval=MANUSCRIPT_CONFIG$output_dirname == 'hstc-inf'}
```

### Network Visualization

```{r child='child/02-consensus-network-visualization.Rmd'}
```

### Save results

```{r save_table_results, message=FALSE}
# Get a list of variables starts with "table_" and save each one to file
tbl_vars <- ls()[grepl('^table_[XS]?[0-9]', ls())]

for (tbl_name in tbl_vars) {
    message(sprintf("Saving %s", tbl_name))

    # Retrieve variable associated with table
    tbl_ <- get(tbl_name)

    # Convert tbl's to  basic data frames; 
    # Prevents issues relating to the format() function
    if (is.tbl(tbl_)) {
        tbl_ <- as.data.frame(tbl_)
    }

    # For single tables, save as TSV
    if (is.matrix(tbl_) || is.data.frame(tbl_)) {
        filename <- sprintf("%s_%s.tab", tbl_name, MANUSCRIPT_CONFIG$output_dirname)

        # write table to file
        write.table(format(tbl_, digits=3), file=file.path(output_tabledir, filename),
                    row.names=FALSE, quote=FALSE, sep="\t")
    } else {
        # Otherwise, if multiple tables stored in a list, save as XLS with
        # separate sheets for each table

        # output filepath
        filename <- sprintf("%s_%s.xlsx", tbl_name, MANUSCRIPT_CONFIG$output_dirname)
        xls_filepath <- file.path(output_tabledir, filename)

        sheet_names <- names(tbl_)

        write.xlsx(as.data.frame(tbl_[[sheet_names[1]]]), file=xls_filepath,
                   sheetName=sheet_names[1], row.names=FALSE)

        for (sheet in sheet_names[2:length(sheet_names)]) {
            # free up Java memory on each loop iteration
            # http://stackoverflow.com/questions/21937640/handling-java-lang-outofmemoryerror-when-writing-to-excel-from-r
            .jcall("java/lang/System", method = "gc")

            write.xlsx(as.data.frame(tbl_[[sheet]]), file=xls_filepath,
                       sheetName=sheet, row.names=FALSE, append=TRUE)
        }
    }
}
```

```{r save_rdata_results, message=FALSE}
#save(adjmat, file=file.path(output_datadir, 'adjmat_unfiltered.rda'))
message("Saving RData objects")
save(filtered_adjmat, file=file.path(output_datadir, paste0('adjmat_filtered_', output_suffix, '.rda')))
save(gene_info, file=file.path(output_datadir, paste0('gene_info_', output_suffix, '.rda')))
save(module_go_enrichment, file=file.path(output_datadir, paste0('module_go_enrichment_', output_suffix, '.rda')))
save(module_kegg_enrichment, file=file.path(output_datadir, paste0('module_kegg_enrichment_', output_suffix, '.rda')))

if (CONFIG$target == 'host') {
    save(module_cpdb_enrichment, file=file.path(output_datadir, paste0('module_cpdb_enrichment_', output_suffix, '.rda')))
    save(module_coreg_enrichment, file=file.path(output_datadir, paste0('module_coreg_enrichment_', output_suffix, '.rda')))
}
```

```{r save_network, message=FALSE}
message("Saving consensus network GraphML")

# add secretion / GPI-anchor status cols (pathogen only)
if (CONFIG$target == 'pathogen') {
    annot$gpi_anchored <- gpi_anchored_gene_status
    annot$secreted <- secreted_gene_status
}

# rescale edge weights to 0 - 1 and save network
filtered_adjmat <- log1p(filtered_adjmat)
filtered_adjmat <- filtered_adjmat / max(filtered_adjmat)

filtered_net_filepath <- file.path(output_datadir,
                                   paste0('edge_weight_filtered_network_', 
                                          output_suffix, '.graphml'))

g <- export_network_to_graphml(filtered_adjmat,
                               filtered_net_filepath,
                               threshold=0, max_edge_ratio=5,
                               nodeAttrDataFrame=annot)
```

## Downloads

```{r downloads, results='asis'}
for (d in c(output_datadir, output_tabledir)) {
    files <- list.files(d)
    for (x in files[grepl(output_suffix, files)]) {
        cat(sprintf('- [%s](%s)\n', basename(x), sub(output_prefix, '', x)))
    }
}
```

```{r save_output}
# Give rmarkdown some time to finish convern and then copy original rmarkdown
# along with output images and HTML to archive location
html_filepath <- file.path(output_prefix, paste0('consesus_network_', MANUSCRIPT_CONFIG$output_dirname, '.html'))

if (opts_knit$get("rmarkdown.pandoc.to") == 'latex') {
    system(sprintf('(sleep 30 && mv 02-network-construction.pdf %s) &', html_filepath))
} else {
    system(sprintf('(sleep 30 && mv 02-network-construction.html %s) &', html_filepath))
}
```
